<!-- python3 -m http.server 8000 -->
<!-- http://localhost:8000/main.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</title>
  <link rel="stylesheet" href="main.css"> 
   <script src="https://cdn.jsdelivr.net/npm/roslib@1.0.1/build/roslib.min.js"></script>
</head>
<body>
    <script>
        fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => {
            console.log("æ”¶åˆ° Node.jsï¼š", sql_data);
        });
    </script>

    <header>
        <h1>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</h1>
        <button id="logoutBtn">ç™»å‡º</button>
    </header>

    <main class="container">
        <section class="video-feed-section">
            <div class="card video-card">
                <h2>å³æ™‚å½±åƒ</h2>
                <div class="video-controls">
                    <label for="image_change">å½±åƒä¾†æº:</label>
                    <select id="image_change">
                        <option value="raw">åŸåœ– (raw)</option>
                        <option value="processed">å½±åƒè™•ç†åœ– (processed)</option>
                    </select>
                </div>
                <div class="image-display-wrapper">
                    <!-- <img id="cam" src="http://10.50.65.122:8080/stream?topic=/camera_image" alt="å³æ™‚å½±åƒä¸²æµ">
                    <img id="cam_processed" src="http://10.50.65.122:8080/stream?topic=/camera_image_fix" alt="å³æ™‚å½±åƒä¸²æµ" style="display:none;"> -->
                    
                    <img id="cam" alt="å³æ™‚å½±åƒä¸²æµ">
                    <img id="cam_processed" alt="å³æ™‚å½±åƒä¸²æµ" style="display:none;">
                    <canvas id="drawCanvas" style="position: absolute; left: 0; top: 0;"></canvas>
                </div>
                <div class="x_y_position">
                    <!-- <p>ç¶²é åº§æ¨™</p> -->
                    <p>x:</p>
                    <p id="mouse_x">0</p>
                    <p>y:</p>
                    <p id="mouse_y">0</p>
                </div>
                <!-- æ¸¬è©¦ä¸­12/15 åŠ‰ä¸ç¿” --> 
                <div class="x_y_position">
                    <!-- <p>ç‰¹æ®Šåº§æ¨™</p> -->
                    <p>x:</p>
                    <p id="mouse_camera_x">0</p>
                    <p>y:</p>
                    <p id="mouse_camera_y">0</p>
                </div>
                <div>
                    <button onclick="draw_round()">æŠ“è»Šå­</button>
                    <button onclick="drow_clear()">æ¸…é™¤</button>

                    <button class="action-draw-btn-function secondary" onclick="selectMode_draw(this)" name="1">ç•«ç·š</button>
                    <button class="action-draw-btn-function secondary" onclick="draw_line(), selectMode_draw(this)" name="2">ç•«çŸ©å½¢</button>
                    <button class="action-draw-btn-function secondary" onclick="draw_line(), selectMode_draw(this)" name="3">ç•«ä¸‰è§’å½¢</button>
                    <button class="action-draw-btn-function secondary" onclick="draw_line(), selectMode_draw(this)" name="4">ç•«å¤šé‚Šå½¢</button>
                </div>
                <!-- é–‹ç™¼å°ˆç”¨ -->
                <div>
                    <p id="function_three_data" style="display: none;"></p>
                </div>
            </div>
            <div class="card basic-control-card" id="machines-container">
                <h2>ç•¶å‰æ©Ÿå°ç‹€æ³</h2>
                    <!-- <div>
                        <p>æ©Ÿå°1</p>
                        <p>é›»é‡ï¼š</p>
                        <p>60%</p>
                        <p>é€Ÿåº¦ï¼š</p>
                        <p>10m</p>
                        <p>è§’é€Ÿåº¦ï¼š</p>
                        
                        <p>ç•¶å‰ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <p>ç›®æ¨™ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <button>ç·Šæ€¥åœæ­¢</button>
                    </div> -->
            </div>
        </section>

<script>
    function renderMachines(sql_data) {
        const container = document.getElementById("machines-container");
        container.innerHTML = "";
        sql_data.forEach(machine => {
            const div = document.createElement("div");
            const localId = `local-pos-${machine.car_number}`;
            const targetId = `target-pos-${machine.car_number}`;

            div.innerHTML = `
                <p>æ©Ÿå° ${machine.car_number}</p>
                <p>é›»é‡ï¼š</p>
                <p>60%</p>
                <p>é€Ÿåº¦ï¼š</p>
                <p>${machine.line_speed} m/s</p>
                <p>è§’é€Ÿåº¦ï¼š</p>
                <p>${machine.angle_speed} m/s</p>
                <p>ç•¶å‰ä½ç½®ï¼š</p>
                <p id="${localId}">(11,-02)</p>
                <p>ç›®æ¨™ä½ç½®ï¼š</p>
                <p id="${targetId}" onclick="editTarget('${targetId}')"> è¨­å®šç›®æ¨™ </p>
                <p>ç‹€æ…‹ï¼š</p>
                <p> ç„¡è³‡æ–™ </p>
                <div class="machine-actions-group">
                    <button class="action-btn primary" onclick="startMoving(${machine.car_number}, '${localId}', '${targetId}')">å‡ºç™¼</button>
                    <button class="action-btn danger" onclick="emergencyStop(${machine.car_number})">ç·Šæ€¥åœæ­¢</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function loadMachines() {
    fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => renderMachines(sql_data))
        .catch(err => console.error("fetch error:", err));
    }

    // åˆæ¬¡è¼‰å…¥
    loadMachines();
</script>
        

        <section class="control-panel-section">
            
            <div class="card basic-control-card">
                <h2>å¤šæ©Ÿæ¨¡å¼</h2>
                <div class="button-group">
                    <button class="action-btn primary" onclick="sendMsg()">é—œé–‰</button>
                    <button class="action-btn primary" onclick="sendMsg()">å•Ÿå‹•</button>
                </div>
            </div>

            <div class="card function-selection-card">
                <h2>åŠŸèƒ½æ¨¡å¼é¸æ“‡</h2>
                <div class="button-group grid-2">
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="1">åŸºç¤æ–¹å‘æ§åˆ¶</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="2">å®šé»ç§»å‹•</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="3">ç¹ªåœ–æ§åˆ¶</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="4">å¤šæ©Ÿå°èˆª</button>
                </div>
            </div>

            <div class="card movement-control-card">
                <h2>åŸºç¤æ–¹å‘æ§åˆ¶</h2>
                <div id="vehicle-select-two">
                    <input type="checkbox" id="vehicle1_check" name="vehicle_select_group" value="1">
                    <label for="vehicle1_check">æ©Ÿå°1</label>
                    
                    <input type="checkbox" id="vehicle2_check" name="vehicle_select_group" value="2">
                    <label for="vehicle2_check">æ©Ÿå°2</label>
                    
                    <input type="checkbox" id="vehicle3_check" name="vehicle_select_group" value="3">
                    <label for="vehicle3_check">æ©Ÿå°3</label>
                    
                    <input type="checkbox" id="vehicle4_check" name="vehicle_select_group" value="4">
                    <label for="vehicle4_check">æ©Ÿå°4</label>
                    
                    <input type="checkbox" id="vehicle5_check" name="vehicle_select_group" value="5">
                    <label for="vehicle5_check">æ©Ÿå°5</label>
                </div>
                <div class="movement-controls">
                    <button class="action-btn tertiary up" onclick="send_direction('1')">â¬†ï¸ å‰ (Front)</button>
                    <button class="action-btn tertiary left" onclick="send_direction('3')">â¬…ï¸ å·¦è½‰ (Lift)</button>
                    <button class="action-btn tertiary rotate-ccw" onclick="send_direction('6')">âŸ² é€†æ™‚é‡ (CCW)</button>
                    <button class="action-btn danger stop" onclick="send_direction('5')">ğŸ›‘ åœ (Stop)</button>
                    <button class="action-btn tertiary rotate-cw" onclick="send_direction('7')">âŸ³ é †æ™‚é‡ (CW)</button>
                    <button class="action-btn tertiary right" onclick="send_direction('4')">â¡ï¸ å³è½‰ (Right)</button>
                    <button class="action-btn tertiary down" onclick="send_direction('2')">â¬‡ï¸ å¾Œ (Back)</button>
                </div>
            </div>

            <div class="card advanced-control-card">
                <h2>é€²éšé‹å‹•åƒæ•¸è¨­å®š</h2>
                <form id="velocity-form" onsubmit="event.preventDefault(); sendVelocityControl();">
                    <div class="form-group">
                        <label for="vehicle-select">é¸æ“‡è»Šè¼›:</label>
                        <select id="vehicle-select" name="vehicle-select">
                            <option value="1">è»Šè¼›1</option>
                            <option value="2">è»Šè¼›2</option>
                            <option value="3">è»Šè¼›3</option>
                            <option value="4">è»Šè¼›4</option>
                            <option value="5">è»Šè¼›5</option>
                            <option value="6">å…¨éƒ¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="linear-speed">ç·šé€Ÿåº¦ (m/s):</label>
                        <input type="number" id="linear-speed" value="0.5" step="0.1" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="angular-speed">è§’é€Ÿåº¦ (rad/s):</label>
                        <input type="number" id="angular-speed" value="0.0" step="0.1" required>
                    </div>

                    <div class="form-actions">
                        <button type="reset" class="action-btn secondary">é‡è¨­</button>
                        <button type="submit" class="action-btn primary">é€å‡ºé€Ÿåº¦æŒ‡ä»¤</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

<script>
    function sendVelocityControl() {
        const vehicleSelect = document.getElementById("vehicle-select").value;
        const linearSpeed = parseFloat(document.getElementById("linear-speed").value);
        const angularSpeed = parseFloat(document.getElementById("angular-speed").value);

        let targets = [];
        if(vehicleSelect === "6") {
            // å…¨éƒ¨è»Šè¼›
            targets = [1,2,3,4,5];
        } else {
            targets = [parseInt(vehicleSelect)];
        }

        // é€ä¸€æ›´æ–°æ¯å°è»Šè¼›
        targets.forEach(car_number => {
            fetch('http://localhost:3000/api/update_machine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    car_number: Number(car_number),
                    line_speed: linearSpeed,
                    angle_speed: angularSpeed
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, vehicleSelect);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, linearSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, angularSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, data);
            })
            .catch(err => console.error('æ›´æ–°éŒ¯èª¤:', err));
        });

        alert("å·²é€å‡ºé€Ÿåº¦æŒ‡ä»¤åˆ°é¸æ“‡çš„è»Šè¼›ï¼");
    }
</script>
    <script>
        /* ========================================= */
        /* å…¨åŸŸåƒæ•¸*/
        /* ========================================= */
        let newString = "";
        let draw_function = "";

        /* ========================================= */
        /* åŠŸèƒ½é¸æ“‡ */
        /* ========================================= */
        function selectMode(button) {
            // 1. æŠŠæ‰€æœ‰æŒ‰éˆ•çš„ active æ‹¿æ‰
            document.querySelectorAll('.action-btn-function').forEach(btn => {
                btn.classList.remove('active');
            });
            newString = button.name

            // 2. æŠŠé»åˆ°çš„æŒ‰éˆ•è®Šæˆ active
            button.classList.add('active');
        }

        /* ========================================= */
        /* ROSçš„é€£æ¥ */
        /* ========================================= */
        const params = new URLSearchParams(window.location.search);
        const ros_ip = params.get('ros_ip');
        console.log('ROS IP:', ros_ip);
        const raw = document.getElementById("cam");
        const processed = document.getElementById("cam_processed");
        cam.src = `http://${ros_ip}:8080/stream?topic=/camera_image`;
        cam_processed.src = `http://${ros_ip}:8080/stream?topic=/camera_image_fix`;
        
        const ros = new ROSLIB.Ros({
            // url: "ws://10.50.65.122:9090"
            url: "ws://" + ros_ip + ":9090"
        });

        ros.on('connection', () => { console.log('å·²é€£æ¥åˆ° rosbridge'); });
        ros.on('error', (error) => { console.log('é€£ç·šéŒ¯èª¤: ', error); });
        ros.on('close', () => { console.log('é€£ç·šé—œé–‰'); });

        // å»ºç«‹ publisher
        const pub = new ROSLIB.Topic({
            ros: ros,
            name: '/web_input',
            messageType: 'std_msgs/String'
        });

        // å»ºç«‹ subscriber
        const sub = new ROSLIB.Topic({
            ros: ros,
            name: '/web_output',
            messageType: 'std_msgs/String'
        });

        const camera_position_data = new ROSLIB.Topic({
            ros: ros,
            name: '/web_position_data',
            messageType: 'std_msgs/String'
        });

        // è¨‚é–±ä¸¦æ¥æ”¶è³‡æ–™
        sub.subscribe((msg) => {
            console.log("æ”¶åˆ°ä¾†è‡ª esp32 çš„è¨Šæ¯:", msg.data);

            // ä½ è¦åœ¨ç•«é¢æ›´æ–°ä¹Ÿå¯ä»¥ï¼Œä¾‹å¦‚ï¼š
            const outputDiv = document.getElementById("ros-output");
            if (outputDiv) {
                outputDiv.innerText = msg.data;
            }

            if(msg.data == "1"){
                drawPoints = document.getElementById("function_three_data").innerHTML;
                drawPoints = drawPoints.slice(0, 2) + drawPoints.slice(10);
                // console.log("drawPoints ç›®å‰:", drawPoints);
                sendDrawDataToROS(drawPoints);
            }
        });
        let carData = {};
        let special_car_x;
        let special_car_y;
        let scale_number;
        camera_position_data.subscribe((msg) => {
            const parts = msg.data.split(",");  // ["id", "x_cm", "y_cm", "yaw_deg", "u_pixel", "v_pixel"]

            let car_id = Number(parts[0]);
            let x = Number(parts[1]);
            let y = Number(parts[2]);
            let yaw = Number(parts[3]);
            // æ›´æ–° carData
            carData[car_id] = { x, y, yaw,};

            // å¦‚æœæ˜¯ ID>0ï¼Œæ›´æ–°ç•«é¢ div
            if (car_id > 0 && car_id < 6) {
                // console.log("id:", car_id ,"id:", x,"id:", y);
                const outputDiv = document.getElementById(`local-pos-${car_id}`);
                    
                if (outputDiv) {
                    outputDiv.innerText = `${x.toFixed(1)}, ${y.toFixed(1)}, ${yaw.toFixed(1)}`;
                }
            }
            if (car_id == 11) {
                const web_mouse_x = document.getElementById(`mouse_x`);
                const web_mouse_y = document.getElementById(`mouse_y`);
                const mouse_x = document.getElementById(`mouse_camera_x`);
                const mouse_y = document.getElementById(`mouse_camera_y`);

                mouse_x.innerText = x.toFixed(1);
                mouse_y.innerText = y.toFixed(1);
                special_car_x = mouse_x.innerText;
                special_car_y = mouse_y.innerText;
                // æ¯”ä¾‹è½‰æ›
                scale_number = 500/mouse_x.innerText;
            }
        });


        /* ========================================= */
        /* I. åŠŸèƒ½1åŸºæœ¬æ§åˆ¶ */
        /* ========================================= */
        // ç™¼é€è¨Šæ¯ (ç”¨æ–¼å¿«é€Ÿæ¸¬è©¦å’ŒåŸºç¤æ–¹å‘æ§åˆ¶)

        let car_number = []; // å­˜æ”¾é¸ä¸­çš„è»Šè¼›

        document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll("#vehicle-select-two input[type='checkbox']");
            console.log("good:", car_number);

            checkboxes.forEach((cb) => {
                cb.addEventListener("change", () => {
                    // æ”¶é›†æ‰€æœ‰è¢«å‹¾é¸çš„å€¼
                    car_number = Array.from(checkboxes)
                                    .filter(c => c.checked)
                                    .map(c => c.value);
                    console.log("ç›®å‰é¸æ“‡è»Šè¼›:", car_number);
                });
            });
        });

        function send_direction(data) {
            if (newString!="1"){
                alert("åªæœ‰åŠŸèƒ½ä¸€æ‰èƒ½ä½¿ç”¨")
                return
            }

            newString += String(data);
            for (let i = 0; i < car_number.length; i++) {
                newString += car_number[i];  // å°‡æ¯å€‹è»Šè¼›è™Ÿç¢¼æ¥ä¸Š
                console.log("good:", newString);
            }
            
            const msg = new ROSLIB.Message({ data: newString });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", newString);
            newString = "1";
        }

        /* ========================================= */
        /* II. å®šé»æ§åˆ¶ */
        /* ========================================= */
        function editTarget(id) {
            const target = document.getElementById(id);

            let value = prompt("è«‹è¼¸å…¥æ–°çš„ç›®æ¨™ä½ç½®æ ¼å¼ï¼šx,yï¼š", target.innerText.trim());

            // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
            if (value === null) return;

            // ç°¡å–®æª¢æŸ¥æ ¼å¼
            if (!/^\s*-?\d+\s*,\s*-?\d+\s*$/.test(value)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ x,y æ ¼å¼ï¼Œä¾‹å¦‚ 3,5");
                return;
            }

            target.innerText = "(" + value + ")";
        }

        function startMoving(car_number, local, goal) {
            if (newString != "2") {
                alert("åªæœ‰åŠŸèƒ½äºŒæ‰èƒ½ä½¿ç”¨");
                return;
            }

            const local_position = document.getElementById(local);
            const goal_position = document.getElementById(goal);

            if (goal_position.innerText.trim() === "è¨­å®šç›®æ¨™") {
                alert("è«‹å…ˆè¨­å®šç›®æ¨™");
                return;
            }

            const localText = local_position.innerText.trim();
            const goalText = goal_position.innerText.trim();

            // æ•´ç†è³‡æ–™
            function extractXY(text) {
                const match = text.match(/\((-?\d+),\s*(-?\d+)\)/);
                return [parseInt(match[1]), parseInt(match[2])];
            }

            const [lx, ly] = extractXY(localText);
            const [gx, gy] = extractXY(goalText);

            // æ­£è² å¥½è½‰æ›
            function encode(n) {
                const sign = n >= 0 ? "0" : "1";     // æ­£ = 0, è²  = 1
                let absNum = Math.abs(n);           // çµ•å°å€¼
                // è½‰æˆå…©ä½æ•¸ï¼Œä¸è¶³è£œ 0
                absNum = absNum.toString().padStart(2, '0');

                return sign + absNum;               // e.g. "0" + "01" â†’ "001"
            }

            const code =
                newString +
                String(car_number) +   // è»Šè™Ÿ
                encode(lx) + encode(ly) +
                encode(gx) + encode(gy);

            const msg = new ROSLIB.Message({ data: code });
            pub.publish(msg);

            console.log("å·²ç™¼é€:", code);
        }

        //æš«åœåŠŸèƒ½
        function emergencyStop(car_number){
            newString = "5"
            newString += String(car_number);
            
            const msg = new ROSLIB.Message({ data: newString });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", newString);
            newString = "1";
        }

        /* ========================================= */
        /* III. åŠŸèƒ½2ç¹ªåœ–æ§åˆ¶ */
        /* ========================================= */
        const canvas = document.getElementById("drawCanvas"); //canvasç©ºé–“
        const ctx = canvas.getContext("2d"); //é‚£å€‹ç©ºé–“æ˜¯2D
        const img = document.getElementById("cam");
        const function_three_data = document.getElementById("function_three_data");

        let drawing = false;
        let drawPoints = "";// é€åˆ°ros2çš„åƒæ•¸

        // å»ºç«‹canvasç©ºé–“
        function syncCanvas() {
            const rect = img.getBoundingClientRect();
            canvas.style.left = rect.left + "px";
            canvas.style.top = rect.top + "px";
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        img.onload = syncCanvas;
        window.onresize = syncCanvas;

        // è¨˜éŒ„æ»‘é¼ ä½ç½®
        document.addEventListener("mousemove", (event) => {
            
            const rect = canvas.getBoundingClientRect();

            const inside =
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom;

            if (!inside) return;

            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            // let y_from_bottom = rect.height - y;
            // let ix = x - centerX;
            // let iy = y_from_bottom - centerY;

            // é¡¯ç¤ºåº§æ¨™
            document.getElementById("mouse_x").innerText = x.toFixed(0);
            document.getElementById("mouse_y").innerText = -y.toFixed(0);

            drawIfNeeded(x, y);
        });

        // æ»‘é¼ æŒ‰ä¸‹ â†’ é–‹å§‹ç•«
        document.addEventListener("mousedown", (event) => {
            const rect = canvas.getBoundingClientRect();

            const inside =
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom;

            if (!inside) return;

            if (newString[0] != "3") {
                alert("åªæœ‰åŠŸèƒ½ä¸‰æ‰èƒ½ä½¿ç”¨");
                return;
            }
            if (!draw_function.includes('1')) {
                alert("éœ€è¦å„ªå…ˆé¸å–ç•«ç·šåŠŸèƒ½");
                return;
            }

            drawPoints += newString
            drawing = true;

            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            // æ‰¾åˆ°æœ€è¿‘çš„åœ“
            let closestX = null;
            let closestY = null;
            let minDist = 50;

            for (let i = 1; i < 6; i++) {
                if (!carData[i]) continue;

                const originX = carData[i].x * scale_number;
                const originY = -carData[i].y * scale_number;

                const dist = Math.hypot(x - originX, y - originY);
                console.log("è·é›¢:", dist)
                if (dist < minDist) {
                    minDist = dist;
                    closestX = originX;
                    closestY = originY;
                    console.log("id:", i);
                    drawPoints += String(i);
                    drawing = true;
                    break;
                }else{
                    drawing = false;
                }
            }

            // å¦‚æœæœ‰æ‰¾åˆ°æœ€è¿‘çš„åœ“ï¼Œä½œç‚ºèµ·é»
            if (closestX !== null && closestY !== null && drawing ==true) {
                // è¨­ç½® Canvas èµ·é»
                ctx.beginPath();
                ctx.moveTo(closestX, closestY);

                console.log("å¾æœ€è¿‘åœ“é–‹å§‹ç•«ç·š: ", closestX, closestY);
            }
        });

        // æ”¾é–‹æ»‘é¼  â†’ åœæ­¢ç•« + ç¢ºèªé€å‡º
        document.addEventListener("mouseup", () => {
            if (drawing == false){
                return;
            }

            if (drawPoints.length > 0) {
                // è©¢å•æ˜¯å¦é€å‡º
                const confirmSend = confirm("ç¹ªåœ–å®Œæˆï¼\næ˜¯å¦é€å‡ºçµ¦ ROSï¼Ÿ");

                if (confirmSend) {
                    sendDrawDataToROS(drawPoints);  // é€å‡ºä¸¦è·³æˆåŠŸè¦–çª—
                } else {
                  drawPoints = "";  // æ¸…ç©º
                  newString = "3";
                }
            }
            drawing = false;
        });

        // é€£çºŒç•«ç·š
        let last_ix = null;
        let last_iy = null;
        function drawIfNeeded(x, y) {
            if (!drawing) {
                return;
            }

            // if (){
            //     alert("èµ·å§‹é»å¿…é ˆè¦è»Šå­ä¸Šé¢");
            // }
            const rect = canvas.getBoundingClientRect();
            //é›¢æ•£åŒ–
            const raw_ix = Math.round(x / 25) * 25;
            const raw_iy = Math.round(y / 25) * 25;

            // è½‰æ›æˆã€Œå·¦ä¸‹è§’ç‚º 0,0ã€
            let ix = raw_ix;
            let iy = raw_iy;
            ix = Math.round(ix / 25) * 25;
            iy = Math.round(iy / 25) * 25;

            if (ix === last_ix && iy === last_iy) {
                return;  // ä¸é‡è¤‡é€å‡º
            }
            last_ix = ix;
            last_iy = iy;
            
            console.log("x:",ix ,"y:",iy)
            // drawPoints += pad3(ix) + pad3
            drawPoints += encodeCoord(ix);
            drawPoints += encodeCoord(iy);

            ctx.lineTo(raw_ix, raw_iy);
            // ctx.lineTo(x, y);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function encodeCoord(x) {
            let ex;

            // x è² æ•¸å°±åŠ  1000ï¼Œæ­£æ•¸å°±åŠ  100
            if (x < 0) {
                ex = 1000 + Math.abs(x); 
            } else {
                ex = String(x).padStart(4, '0'); 
            }

            return String(ex);
        }

        function sendDrawDataToROS(points) {
            function_three_data.innerHTML=points;
            const msg = new ROSLIB.Message({
                data: points
            });

            pub.publish(msg);
            console.log("å·²å‚³çµ¦ ROS:", points);
            drawPoints = "";  // æ¸…ç©ºç´€éŒ„
            newString = "3";
        }

        /* ========================================= */
        /* ç…§ç‰‡é¸æ“‡ */
        /* ========================================= */
        document.getElementById("image_change").addEventListener("change", function() {
            const value = this.value;
            console.log("é¸æ“‡æˆåŠŸ")

            // å…¨éƒ¨å…ˆéš±è—
            raw.style.display = "none";
            processed.style.display = "none";

            // å†é¡¯ç¤ºé¸åˆ°çš„
            if (value === "raw") {
                raw.style.display = "block";
            } 
            else if (value === "processed") {
                processed.style.display = "block";
            }
        });

        /* ========================================= */
        /* ç¹ªåœ–åŠŸèƒ½ */
        /* ========================================= */
        let draw_line_number=0;
        
        function selectMode_draw(button) {
            // åˆ¤æ–·æŒ‰éˆ•æ˜¯å¦å·²ç¶“ active
            const isActive = button.classList.contains('active');

            if (isActive) {
                // å·²ç¶“ active â†’ é»æ“Šå–æ¶ˆ
                button.classList.remove('active');
            } else {
                // å°šæœª active â†’ é»æ“Šè¨­ç‚º active
                button.classList.add('active');
            }

            // é€™è£¡å¯ä»¥æ›´æ–° newString æˆ–å…¶ä»–è³‡æ–™
            // ä¾‹å¦‚å„²å­˜ç›®å‰æ‰€æœ‰ active æŒ‰éˆ•çš„ name
            const activeButtons = Array.from(document.querySelectorAll('.action-draw-btn-function.active'))
                                    .map(btn => btn.name);
            draw_function = activeButtons.join(','); // ä¾‹å¦‚ç”¨é€—è™Ÿä¸²èµ·ä¾†

            console.log("ç›®å‰ active æŒ‰éˆ•:", draw_function);
        }

        // æŠ“è»Šå­
        function draw_round() {
            drow_clear();
            if (!carData[0]) return; // ç¢ºèªåŸé»å­˜åœ¨
            for (let i = 1; i < 6; i++) {
                if (!carData[i]) continue;
                const originX = carData[i].x * scale_number;
                const originY = -carData[i].y * scale_number;
                console.log("id:", i,originX, " ", originY)

                // ç•«åŸé»
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(originX, originY, 10, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = "yellow";
                ctx.strokeStyle = "yellow";
                ctx.font = "14px Arial";
            }
        }
        // ç•«ç·š
        function draw_line() {
        }

        //æ¸…é™¤
        function drow_clear(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        /* ========================================= */
        /* IIII. å¤šæ©Ÿæ§åˆ¶ */
        /* ========================================= */
        function sendMsg() {
            if (newString != "4") {
                alert("åªæœ‰åŠŸèƒ½å››æ‰èƒ½ä½¿ç”¨");
                return;
            }

            const set_goal_position = [[1,2],[1,3],[2,2],[7,2],[6,2],];
            let local_position;
            let goal_position;
            let total_car_date = "4";

            for (let i = 0; i < set_goal_position.length; i++) {
                local_position = document.getElementById(`local-pos-${i+1}`);
                goal_position = document.getElementById(`target-pos-${i+1}`);
                // console.log("å·²ç™¼é€:", goal_position.innerText);
                if (goal_position) {
                    goal_position.innerHTML = set_goal_position[i].join(',');
                }

                let local_text = local_position.innerText.replace(/[()ï¼ˆï¼‰]/g, '');
                let goal_text  = goal_position.innerText.replace(/[()ï¼ˆï¼‰]/g, '');
                console.log("1å·²ç™¼é€:", local_text);

                let [local_text_x, local_text_y] = local_text.split(',');
                let [goal_text_x, goal_text_y]  = goal_text.split(',');

                
                console.log("2å·²ç™¼é€:", local_text_y);
                total_car_date += String(i+1)
                total_car_date += encodeCoord(local_text_x);
                total_car_date += encodeCoord(local_text_y);
                total_car_date += encodeCoord(goal_text_x);
                total_car_date += encodeCoord(goal_text_y);
            }

            const msg = new ROSLIB.Message({ data: String(total_car_date) });
            pub.publish(msg);
            console.log("3å·²ç™¼é€:", total_car_date);
        }

        /* ========================================= */
        /* IV ç‰¹æ®ŠåŠŸèƒ½ */
        /* ========================================= */

        /* ========================================= */
        /* IV ç™»å‡º */
        /* ========================================= */
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", function() {
            localStorage.removeItem("ros_ip");

            window.location.href = "http://localhost:8000/Login.html";
        });

    </script>
</body>
</html>