<!-- python3 -m http.server 8000 -->
<!-- http://localhost:8000/main.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</title>
  <link rel="stylesheet" href="main.css"> 
   <script src="https://cdn.jsdelivr.net/npm/roslib@1.0.1/build/roslib.min.js"></script>
</head>
<body>
    <script>
        fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => {
            console.log("æ”¶åˆ° Node.jsï¼š", sql_data);
        });
    </script>

    <header>
        <h1>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</h1>
    </header>

    <main class="container">
        <section class="video-feed-section">
            <div class="card video-card">
                <h2>å³æ™‚å½±åƒ</h2>
                <div class="video-controls">
                    <label for="image_change">å½±åƒä¾†æº:</label>
                    <select id="image_change">
                        <option value="å‰">åŸåœ– (raw)</option>
                        <option value="å¾Œ">å½±åƒè™•ç†åœ– (processed)</option>
                        <option value="å·¦">æ§åˆ¶æ¨¡å¼ (control mode)</option>
                    </select>
                </div>
                <div class="image-display-wrapper">
                    <img id="cam" src="http://10.50.65.22:8080/stream?topic=/camera_image" alt="å³æ™‚å½±åƒä¸²æµ">
                </div>
                <div class="x_y_position">
                    <p>x:</p>
                    <p id="mouse_x">0</p>
                    <p>y:</p>
                    <p id="mouse_y">0</p>
                </div>
            </div>
            <div class="card basic-control-card" id="machines-container">
                <h2>ç•¶å‰æ©Ÿå°ç‹€æ³</h2>
                    <!-- <div>
                        <p>æ©Ÿå°1</p>
                        <p>é›»é‡ï¼š</p>
                        <p>60%</p>
                        <p>é€Ÿåº¦ï¼š</p>
                        <p>10m</p>
                        <p>è§’é€Ÿåº¦ï¼š</p>
                        
                        <p>ç•¶å‰ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <p>ç›®æ¨™ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <button>ç·Šæ€¥åœæ­¢</button>
                    </div> -->
            </div>
        </section>

<script>
    function renderMachines(sql_data) {
        const container = document.getElementById("machines-container");
        container.innerHTML = ""; // å…ˆæ¸…ç©º
        sql_data.forEach(machine => {
            const div = document.createElement("div");

            div.innerHTML = `
                <p>æ©Ÿå° ${machine.car_number}</p>
                <p>é›»é‡ï¼š</p>
                <p>60%</p>
                <p>é€Ÿåº¦ï¼š</p>
                <p>${machine.line_speed} m/s</p>
                <p>è§’é€Ÿåº¦ï¼š</p>
                <p>${machine.angle_speed} m/s</p>
                <p>ç•¶å‰ä½ç½®ï¼š</p>
                <p>(1,2)</p>
                <p>ç›®æ¨™ä½ç½®ï¼š</p>
                <p>(1,2)</p>
                <button onclick="emergencyStop(${machine.car_number})">ç·Šæ€¥åœæ­¢</button>
            `;
            container.appendChild(div);
        });
    }

    function loadMachines() {
    fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => renderMachines(sql_data))  // â† é€™è£¡å‘¼å« renderMachines
        .catch(err => console.error("fetch error:", err));
    }

    // åˆæ¬¡è¼‰å…¥
    loadMachines();
</script>
        

        <section class="control-panel-section">
            
            <div class="card basic-control-card">
                <h2>å¿«é€Ÿæ¸¬è©¦é€šè¨Š</h2>
                <div class="button-group">
                    <button class="action-btn primary" onclick="sendMsg(1)">1</button>
                    <!-- <button class="action-btn primary" onclick="sendMsg(2)">2</button>
                    <button class="action-btn primary" onclick="sendMsg(3)">3</button> -->
                </div>
            </div>

            <div class="card function-selection-card">
                <h2>åŠŸèƒ½æ¨¡å¼é¸æ“‡</h2>
                <div class="button-group grid-2">
                    <button class="action-btn secondary" onclick="">åŸºç¤æ–¹å‘æ§åˆ¶</button>
                    <button class="action-btn secondary" onclick="">ç¹ªåœ–æ§åˆ¶</button>
                    <button class="action-btn secondary" onclick="">å…¨è‡ªå‹•å°èˆª</button>
                    <button class="action-btn secondary" onclick="">å…¶ä»–è¨­å®š</button>
                </div>
            </div>

            <div class="card movement-control-card">
                <h2>åŸºç¤æ–¹å‘æ§åˆ¶</h2>
                <div id="vehicle-select-two">
                    <input type="checkbox" id="vehicle1_check" name="vehicle_select_group" value="1">
                    <label for="vehicle1_check">æ©Ÿå°1</label>
                    
                    <input type="checkbox" id="vehicle2_check" name="vehicle_select_group" value="2">
                    <label for="vehicle2_check">æ©Ÿå°2</label>
                    
                    <input type="checkbox" id="vehicle3_check" name="vehicle_select_group" value="3">
                    <label for="vehicle3_check">æ©Ÿå°3</label>
                    
                    <input type="checkbox" id="vehicle4_check" name="vehicle_select_group" value="4">
                    <label for="vehicle4_check">æ©Ÿå°4</label>
                    
                    <input type="checkbox" id="vehicle5_check" name="vehicle_select_group" value="5">
                    <label for="vehicle5_check">æ©Ÿå°5</label>
                </div>
                <div class="movement-controls">
                    <button class="action-btn tertiary up" onclick="send_direction('1')">â¬†ï¸ å‰ (Front)</button>
                    <button class="action-btn tertiary left" onclick="send_direction('3')">â¬…ï¸ å·¦è½‰ (Lift)</button>
                    <button class="action-btn danger stop" onclick="send_direction('5')">ğŸ›‘ åœ (Stop)</button>
                    <button class="action-btn tertiary right" onclick="send_direction('4')">â¡ï¸ å³è½‰ (Right)</button>
                    <button class="action-btn tertiary down" onclick="send_direction('2')">â¬‡ï¸ å¾Œ (Back)</button>
                </div>
            </div>

            <div class="card advanced-control-card">
                <h2>é€²éšé‹å‹•åƒæ•¸è¨­å®š</h2>
                <form id="velocity-form" onsubmit="event.preventDefault(); sendVelocityControl();">
                    <div class="form-group">
                        <label for="vehicle-select">é¸æ“‡è»Šè¼›:</label>
                        <select id="vehicle-select" name="vehicle-select">
                            <option value="1">è»Šè¼›1</option>
                            <option value="2">è»Šè¼›2</option>
                            <option value="3">è»Šè¼›3</option>
                            <option value="4">è»Šè¼›4</option>
                            <option value="5">è»Šè¼›5</option>
                            <option value="6">å…¨éƒ¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="linear-speed">ç·šé€Ÿåº¦ (m/s):</label>
                        <input type="number" id="linear-speed" value="0.5" step="0.1" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="angular-speed">è§’é€Ÿåº¦ (rad/s):</label>
                        <input type="number" id="angular-speed" value="0.0" step="0.1" required>
                    </div>

                    <div class="form-actions">
                        <button type="reset" class="action-btn secondary">é‡è¨­</button>
                        <button type="submit" class="action-btn primary">é€å‡ºé€Ÿåº¦æŒ‡ä»¤</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

<script>
    function sendVelocityControl() {
        const vehicleSelect = document.getElementById("vehicle-select").value;
        const linearSpeed = parseFloat(document.getElementById("linear-speed").value);
        const angularSpeed = parseFloat(document.getElementById("angular-speed").value);

        let targets = [];
        if(vehicleSelect === "6") {
            // å…¨éƒ¨è»Šè¼›
            targets = [1,2,3,4,5];
        } else {
            targets = [parseInt(vehicleSelect)];
        }

        // é€ä¸€æ›´æ–°æ¯å°è»Šè¼›
        targets.forEach(car_number => {
            fetch('http://localhost:3000/api/update_machine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    car_number: Number(car_number),
                    line_speed: linearSpeed,
                    angle_speed: angularSpeed
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, vehicleSelect);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, linearSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, angularSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, data);
            })
            .catch(err => console.error('æ›´æ–°éŒ¯èª¤:', err));
        });

        alert("å·²é€å‡ºé€Ÿåº¦æŒ‡ä»¤åˆ°é¸æ“‡çš„è»Šè¼›ï¼");
    }
</script>

    <script>
        /* ========================================= */
        /* I. ROSçš„é€£æ¥ */
        /* ========================================= */
        const ros = new ROSLIB.Ros({
            url: "ws://10.50.65.22:9090"
        });

        ros.on('connection', () => { console.log('å·²é€£æ¥åˆ° rosbridge'); });
        ros.on('error', (error) => { console.log('é€£ç·šéŒ¯èª¤: ', error); });
        ros.on('close', () => { console.log('é€£ç·šé—œé–‰'); });

        // å»ºç«‹ publisher
        const pub = new ROSLIB.Topic({
            ros: ros,
            name: '/web_input',
            messageType: 'std_msgs/String'
        });

        /* ========================================= */
        /* II. åŠŸèƒ½1åŸºæœ¬æ§åˆ¶ */
        /* ========================================= */
        // ç™¼é€è¨Šæ¯ (ç”¨æ–¼å¿«é€Ÿæ¸¬è©¦å’ŒåŸºç¤æ–¹å‘æ§åˆ¶)

        let car_number = []; // å­˜æ”¾é¸ä¸­çš„è»Šè¼›

        document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll("#vehicle-select-two input[type='checkbox']");
            console.log("good:", car_number);

            checkboxes.forEach((cb) => {
                cb.addEventListener("change", () => {
                    // æ”¶é›†æ‰€æœ‰è¢«å‹¾é¸çš„å€¼
                    car_number = Array.from(checkboxes)
                                    .filter(c => c.checked)
                                    .map(c => c.value);
                    console.log("ç›®å‰é¸æ“‡è»Šè¼›:", car_number);
                });
            });
        });

        function send_direction(data) {
            let newString = "1";
            newString += String(data);
            for (let i = 0; i < car_number.length; i++) {
                newString += car_number[i];  // å°‡æ¯å€‹è»Šè¼›è™Ÿç¢¼æ¥ä¸Š
                console.log("good:", newString);
            }
            
            const msg = new ROSLIB.Message({ data: newString });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", newString);
        }

        /* ========================================= */
        /* III. åŠŸèƒ½2ç¹ªåœ–æ§åˆ¶ */
        /* ========================================= */
        //æ»‘é¼ åº§æ¨™
        document.addEventListener("mousemove", function(event) {
            const img = document.getElementById("cam");
            const rect = img.getBoundingClientRect();

            const inside =
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom;

            if (!inside) return;

            // è¨ˆç®—ç›¸å°æ–¼åœ–ç‰‡å·¦ä¸Šè§’çš„åº§æ¨™
            let x = event.clientX - rect.left;
            let y_from_top = event.clientY - rect.top;

            // æŠŠåæ¨™è½‰æ›æˆã€Œå·¦ä¸‹è§’ç‚º 0,0ã€
            let y = rect.height - y_from_top;

            // event.clientX, event.clientY = æ»‘é¼ åœ¨è¦–çª—çš„åº§æ¨™
            document.getElementById("mouse_x").innerText = x.toFixed(0);
            document.getElementById("mouse_y").innerText = y.toFixed(0);
        });

        // å°šæœªå¯¦ä½œ sendVelocityControl() å‡½å¼ï¼Œç”¨æ–¼é€å‡ºé€Ÿåº¦/è§’é€Ÿåº¦
        // function sendVelocityControl() {
        //     console.log("æ­¤åŠŸèƒ½éœ€è¦é¡å¤– ROS ç¯€é»è™•ç†é€Ÿåº¦æŒ‡ä»¤");
        // }

        /* ========================================= */
        /* IIII. ç‰¹æ®ŠåŠŸèƒ½ */
        /* ========================================= */
        function sendMsg(data) {
            const msg = new ROSLIB.Message({ data: String(data) });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", data);
        }

    </script>
</body>
</html>