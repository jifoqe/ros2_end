<!-- python3 -m http.server 8000 -->
<!-- http://localhost:8000/main.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</title>
  <link rel="stylesheet" href="main.css"> 
   <script src="https://cdn.jsdelivr.net/npm/roslib@1.0.1/build/roslib.min.js"></script>
</head>
<body>
    <script>
        fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => {
            console.log("æ”¶åˆ° Node.jsï¼š", sql_data);
        });
    </script>

    <header>
        <h1>ROS2 é ç«¯æ§åˆ¶ä»‹é¢</h1>
    </header>

    <main class="container">
        <section class="video-feed-section">
            <div class="card video-card">
                <h2>å³æ™‚å½±åƒ</h2>
                <div class="video-controls">
                    <label for="image_change">å½±åƒä¾†æº:</label>
                    <select id="image_change">
                        <option value="raw">åŸåœ– (raw)</option>
                        <option value="processed">å½±åƒè™•ç†åœ– (processed)</option>
                    </select>
                </div>
                <div class="image-display-wrapper">
                    <img id="cam" src="http://10.50.65.22:8080/stream?topic=/camera_image" alt="å³æ™‚å½±åƒä¸²æµ">
                    <img id="cam_processed" src="http://10.50.65.22:8080/stream?topic=/camera_image_fix" alt="å³æ™‚å½±åƒä¸²æµ" style="display:none;">
                    <canvas id="drawCanvas" style="position: absolute; left: 0; top: 0;"></canvas>
                </div>
                <div class="x_y_position">
                    <p>x:</p>
                    <p id="mouse_x">0</p>
                    <p>y:</p>
                    <p id="mouse_y">0</p>
                </div>
            </div>
            <div class="card basic-control-card" id="machines-container">
                <h2>ç•¶å‰æ©Ÿå°ç‹€æ³</h2>
                    <!-- <div>
                        <p>æ©Ÿå°1</p>
                        <p>é›»é‡ï¼š</p>
                        <p>60%</p>
                        <p>é€Ÿåº¦ï¼š</p>
                        <p>10m</p>
                        <p>è§’é€Ÿåº¦ï¼š</p>
                        
                        <p>ç•¶å‰ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <p>ç›®æ¨™ä½ç½®ï¼š</p>
                        <p>(1,2)</p>
                        <button>ç·Šæ€¥åœæ­¢</button>
                    </div> -->
            </div>
        </section>

<script>
    function renderMachines(sql_data) {
        const container = document.getElementById("machines-container");
        container.innerHTML = ""; // å…ˆæ¸…ç©º
        sql_data.forEach(machine => {
            const div = document.createElement("div");
            const localId = `local-pos-${machine.car_number}`;
            const targetId = `target-pos-${machine.car_number}`;

            div.innerHTML = `
                <p>æ©Ÿå° ${machine.car_number}</p>
                <p>é›»é‡ï¼š</p>
                <p>60%</p>
                <p>é€Ÿåº¦ï¼š</p>
                <p>${machine.line_speed} m/s</p>
                <p>è§’é€Ÿåº¦ï¼š</p>
                <p>${machine.angle_speed} m/s</p>
                <p>ç•¶å‰ä½ç½®ï¼š</p>
                <p id="${localId}">(11,-02)</p>
                <p>ç›®æ¨™ä½ç½®ï¼š</p>
                <p id="${targetId}" onclick="editTarget('${targetId}')"> è¨­å®šç›®æ¨™ </p>
                <p>è·é›¢ï¼š</p>
                <p> ç„¡è³‡æ–™ </p>
                <div class="machine-actions-group">
                    <button class="action-btn primary" onclick="startMoving(${machine.car_number}, '${localId}', '${targetId}')">å‡ºç™¼</button>
                    <button class="action-btn danger" onclick="emergencyStop(${machine.car_number})">ç·Šæ€¥åœæ­¢</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function loadMachines() {
    fetch("http://localhost:3000/api/data")
        .then(res => res.json())
        .then(sql_data => renderMachines(sql_data))  // â† é€™è£¡å‘¼å« renderMachines
        .catch(err => console.error("fetch error:", err));
    }

    // åˆæ¬¡è¼‰å…¥
    loadMachines();
</script>
        

        <section class="control-panel-section">
            
            <div class="card basic-control-card">
                <h2>å¿«é€Ÿæ¸¬è©¦é€šè¨Š</h2>
                <div class="button-group">
                    <button class="action-btn primary" onclick="sendMsg(1)">1</button>
                    <button class="action-btn primary" onclick="sendMsg(2)">2</button>
                    <button class="action-btn primary" onclick="sendMsg(3)">3</button>
                </div>
            </div>

            <div class="card function-selection-card">
                <h2>åŠŸèƒ½æ¨¡å¼é¸æ“‡</h2>
                <div class="button-group grid-2">
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="1">åŸºç¤æ–¹å‘æ§åˆ¶</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="2">å®šé»ç§»å‹•</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="3">ç¹ªåœ–æ§åˆ¶</button>
                    <button class="action-btn-function secondary" onclick="selectMode(this)" name="4">å¤šæ©Ÿå°èˆª</button>
                </div>
            </div>

            <div class="card movement-control-card">
                <h2>åŸºç¤æ–¹å‘æ§åˆ¶</h2>
                <div id="vehicle-select-two">
                    <input type="checkbox" id="vehicle1_check" name="vehicle_select_group" value="1">
                    <label for="vehicle1_check">æ©Ÿå°1</label>
                    
                    <input type="checkbox" id="vehicle2_check" name="vehicle_select_group" value="2">
                    <label for="vehicle2_check">æ©Ÿå°2</label>
                    
                    <input type="checkbox" id="vehicle3_check" name="vehicle_select_group" value="3">
                    <label for="vehicle3_check">æ©Ÿå°3</label>
                    
                    <input type="checkbox" id="vehicle4_check" name="vehicle_select_group" value="4">
                    <label for="vehicle4_check">æ©Ÿå°4</label>
                    
                    <input type="checkbox" id="vehicle5_check" name="vehicle_select_group" value="5">
                    <label for="vehicle5_check">æ©Ÿå°5</label>
                </div>
                <div class="movement-controls">
                    <button class="action-btn tertiary up" onclick="send_direction('1')">â¬†ï¸ å‰ (Front)</button>
                    <button class="action-btn tertiary left" onclick="send_direction('3')">â¬…ï¸ å·¦è½‰ (Lift)</button>
                    <button class="action-btn danger stop" onclick="send_direction('5')">ğŸ›‘ åœ (Stop)</button>
                    <button class="action-btn tertiary right" onclick="send_direction('4')">â¡ï¸ å³è½‰ (Right)</button>
                    <button class="action-btn tertiary down" onclick="send_direction('2')">â¬‡ï¸ å¾Œ (Back)</button>
                </div>
            </div>

            <div class="card advanced-control-card">
                <h2>é€²éšé‹å‹•åƒæ•¸è¨­å®š</h2>
                <form id="velocity-form" onsubmit="event.preventDefault(); sendVelocityControl();">
                    <div class="form-group">
                        <label for="vehicle-select">é¸æ“‡è»Šè¼›:</label>
                        <select id="vehicle-select" name="vehicle-select">
                            <option value="1">è»Šè¼›1</option>
                            <option value="2">è»Šè¼›2</option>
                            <option value="3">è»Šè¼›3</option>
                            <option value="4">è»Šè¼›4</option>
                            <option value="5">è»Šè¼›5</option>
                            <option value="6">å…¨éƒ¨</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="linear-speed">ç·šé€Ÿåº¦ (m/s):</label>
                        <input type="number" id="linear-speed" value="0.5" step="0.1" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="angular-speed">è§’é€Ÿåº¦ (rad/s):</label>
                        <input type="number" id="angular-speed" value="0.0" step="0.1" required>
                    </div>

                    <div class="form-actions">
                        <button type="reset" class="action-btn secondary">é‡è¨­</button>
                        <button type="submit" class="action-btn primary">é€å‡ºé€Ÿåº¦æŒ‡ä»¤</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

<script>
    function sendVelocityControl() {
        const vehicleSelect = document.getElementById("vehicle-select").value;
        const linearSpeed = parseFloat(document.getElementById("linear-speed").value);
        const angularSpeed = parseFloat(document.getElementById("angular-speed").value);

        let targets = [];
        if(vehicleSelect === "6") {
            // å…¨éƒ¨è»Šè¼›
            targets = [1,2,3,4,5];
        } else {
            targets = [parseInt(vehicleSelect)];
        }

        // é€ä¸€æ›´æ–°æ¯å°è»Šè¼›
        targets.forEach(car_number => {
            fetch('http://localhost:3000/api/update_machine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    car_number: Number(car_number),
                    line_speed: linearSpeed,
                    angle_speed: angularSpeed
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, vehicleSelect);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, linearSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, angularSpeed);
                console.log(`è»Šè¼›${car_number} æ›´æ–°çµæœ:`, data);
            })
            .catch(err => console.error('æ›´æ–°éŒ¯èª¤:', err));
        });

        alert("å·²é€å‡ºé€Ÿåº¦æŒ‡ä»¤åˆ°é¸æ“‡çš„è»Šè¼›ï¼");
    }
</script>
    <script>
        /* ========================================= */
        /* å…¨åŸŸåƒæ•¸*/
        /* ========================================= */
        let newString = "";

        /* ========================================= */
        /* åŠŸèƒ½é¸æ“‡ */
        /* ========================================= */
        function selectMode(button) {
            // 1. æŠŠæ‰€æœ‰æŒ‰éˆ•çš„ active æ‹¿æ‰
            document.querySelectorAll('.action-btn-function').forEach(btn => {
                btn.classList.remove('active');
            });
            newString = button.name

            // 2. æŠŠé»åˆ°çš„æŒ‰éˆ•è®Šæˆ active
            button.classList.add('active');
        }

        /* ========================================= */
        /* ROSçš„é€£æ¥ */
        /* ========================================= */
        const ros = new ROSLIB.Ros({
            url: "ws://10.50.65.22:9090"
        });

        ros.on('connection', () => { console.log('å·²é€£æ¥åˆ° rosbridge'); });
        ros.on('error', (error) => { console.log('é€£ç·šéŒ¯èª¤: ', error); });
        ros.on('close', () => { console.log('é€£ç·šé—œé–‰'); });

        // å»ºç«‹ publisher
        const pub = new ROSLIB.Topic({
            ros: ros,
            name: '/web_input',
            messageType: 'std_msgs/String'
        });

        // å»ºç«‹ subscriber
        const sub = new ROSLIB.Topic({
            ros: ros,
            name: '/web_output',        // â­ä½ è¦æ¥æ”¶çš„ Topic
            messageType: 'std_msgs/String'
        });

        // è¨‚é–±ä¸¦æ¥æ”¶è³‡æ–™
        sub.subscribe((msg) => {
            console.log("æ”¶åˆ°ä¾†è‡ª ROS çš„è¨Šæ¯:", msg.data);

            // ä½ è¦åœ¨ç•«é¢æ›´æ–°ä¹Ÿå¯ä»¥ï¼Œä¾‹å¦‚ï¼š
            const outputDiv = document.getElementById("ros-output");
            if (outputDiv) {
                outputDiv.innerText = msg.data;
            }
        });


        /* ========================================= */
        /* I. åŠŸèƒ½1åŸºæœ¬æ§åˆ¶ */
        /* ========================================= */
        // ç™¼é€è¨Šæ¯ (ç”¨æ–¼å¿«é€Ÿæ¸¬è©¦å’ŒåŸºç¤æ–¹å‘æ§åˆ¶)

        let car_number = []; // å­˜æ”¾é¸ä¸­çš„è»Šè¼›

        document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll("#vehicle-select-two input[type='checkbox']");
            console.log("good:", car_number);

            checkboxes.forEach((cb) => {
                cb.addEventListener("change", () => {
                    // æ”¶é›†æ‰€æœ‰è¢«å‹¾é¸çš„å€¼
                    car_number = Array.from(checkboxes)
                                    .filter(c => c.checked)
                                    .map(c => c.value);
                    console.log("ç›®å‰é¸æ“‡è»Šè¼›:", car_number);
                });
            });
        });

        function send_direction(data) {
            if (newString!="1"){
                alert("åªæœ‰åŠŸèƒ½ä¸€æ‰èƒ½ä½¿ç”¨")
                return
            }

            newString += String(data);
            for (let i = 0; i < car_number.length; i++) {
                newString += car_number[i];  // å°‡æ¯å€‹è»Šè¼›è™Ÿç¢¼æ¥ä¸Š
                console.log("good:", newString);
            }
            
            const msg = new ROSLIB.Message({ data: newString });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", newString);
            newString = "1";
        }

        /* ========================================= */
        /* II. å®šé»æ§åˆ¶ */
        /* ========================================= */
        function editTarget(id) {
            const target = document.getElementById(id);

            let value = prompt("è«‹è¼¸å…¥æ–°çš„ç›®æ¨™ä½ç½®æ ¼å¼ï¼šx,yï¼š", target.innerText.trim());

            // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
            if (value === null) return;

            // ç°¡å–®æª¢æŸ¥æ ¼å¼
            if (!/^\s*-?\d+\s*,\s*-?\d+\s*$/.test(value)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ x,y æ ¼å¼ï¼Œä¾‹å¦‚ 3,5");
                return;
            }

            target.innerText = "(" + value + ")";
        }

        function startMoving(car_number, local, goal) {
            if (newString != "2") {
                alert("åªæœ‰åŠŸèƒ½äºŒæ‰èƒ½ä½¿ç”¨");
                return;
            }

            const local_position = document.getElementById(local);
            const goal_position = document.getElementById(goal);

            if (goal_position.innerText.trim() === "è¨­å®šç›®æ¨™") {
                alert("è«‹å…ˆè¨­å®šç›®æ¨™");
                return;
            }

            const localText = local_position.innerText.trim();
            const goalText = goal_position.innerText.trim();

            // æ•´ç†è³‡æ–™
            function extractXY(text) {
                const match = text.match(/\((-?\d+),\s*(-?\d+)\)/);
                return [parseInt(match[1]), parseInt(match[2])];
            }

            const [lx, ly] = extractXY(localText);
            const [gx, gy] = extractXY(goalText);

            // æ­£è² å¥½è½‰æ›
            function encode(n) {
                const sign = n >= 0 ? "0" : "1";     // æ­£ = 0, è²  = 1
                let absNum = Math.abs(n);           // çµ•å°å€¼
                // è½‰æˆå…©ä½æ•¸ï¼Œä¸è¶³è£œ 0
                absNum = absNum.toString().padStart(2, '0');

                return sign + absNum;               // e.g. "0" + "01" â†’ "001"
            }

            const code =
                newString +
                String(car_number) +   // è»Šè™Ÿ
                encode(lx) + encode(ly) +
                encode(gx) + encode(gy);

            const msg = new ROSLIB.Message({ data: code });
            pub.publish(msg);

            console.log("å·²ç™¼é€:", code);
        }

        //æš«åœåŠŸèƒ½
        function emergencyStop(car_number){
            newString = "5"
            newString += String(car_number);
            
            const msg = new ROSLIB.Message({ data: newString });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", newString);
            newString = "1";
        }

        /* ========================================= */
        /* III. åŠŸèƒ½2ç¹ªåœ–æ§åˆ¶ */
        /* ========================================= */
        const canvas = document.getElementById("drawCanvas");
        const ctx = canvas.getContext("2d");
        const img = document.getElementById("cam");

        let drawing = false;
        let drawPoints = "";

        // è®“ canvas å®Œç¾é‡ç–Šå½±åƒ
        function syncCanvas() {
            const rect = img.getBoundingClientRect();
            canvas.style.left = rect.left + "px";
            canvas.style.top = rect.top + "px";
            canvas.width = rect.width;
            canvas.height = rect.height;
        }

        img.onload = syncCanvas;
        window.onresize = syncCanvas;

        // è¨˜éŒ„æ»‘é¼ ä½ç½®
        document.addEventListener("mousemove", (event) => {
            
            const rect = canvas.getBoundingClientRect();

            const inside =
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom;

            if (!inside) return;

            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            // ä½ è¦ã€Œå·¦ä¸‹è§’ç‚º 0,0ã€ â†’ è‡ªå·±è½‰æ›
            let y_from_bottom = rect.height - y;

            // é¡¯ç¤ºåº§æ¨™
            document.getElementById("mouse_x").innerText = x.toFixed(0);
            document.getElementById("mouse_y").innerText = y_from_bottom.toFixed(0);

            drawIfNeeded(x, y);
        });

        // æ»‘é¼ æŒ‰ä¸‹ â†’ é–‹å§‹ç•«
        document.addEventListener("mousedown", (event) => {
            const rect = canvas.getBoundingClientRect();

            const inside =
                event.clientX >= rect.left &&
                event.clientX <= rect.right &&
                event.clientY >= rect.top &&
                event.clientY <= rect.bottom;

            if (!inside) return;

            if (newString != "3") {
                alert("åªæœ‰åŠŸèƒ½ä¸‰æ‰èƒ½ä½¿ç”¨");
                return;
            }

            if (car_number == "") {
                alert("é¸æ“‡è»Šè¼›");
                return;
            }

            for (let i = 0; i < car_number.length; i++) {
                newString += car_number[i];
            }
            drawPoints += newString
            drawing = true;

            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(x, y);
        });

        // æ”¾é–‹æ»‘é¼  â†’ åœæ­¢ç•«
        document.addEventListener("mouseup", () => {
            drawing = false;

            if (drawPoints.length > 0) {
                sendDrawDataToROS(drawPoints);
            }
        });

        // é€£çºŒç•«ç·š
        let last_ix = null;
        let last_iy = null;
        function drawIfNeeded(x, y) {
            if (!drawing) {
                return;
            }
            const rect = canvas.getBoundingClientRect();
            //é›¢æ•£åŒ–
            const raw_ix = Math.round(x / 25) * 25;
            const raw_iy = Math.round(y / 25) * 25;
            // è½‰æ›æˆã€Œå·¦ä¸‹è§’ç‚º 0,0ã€
            let ix = raw_ix;
            let iy = rect.height - raw_iy;
            ix = Math.round(ix / 25) * 25;
            iy = Math.round(iy / 25) * 25;

            if (ix === last_ix && iy === last_iy) {
                return;  // ä¸é‡è¤‡é€å‡º
            }
            last_ix = ix;
            last_iy = iy;
            
            console.log("x:",ix ,"y:",iy)
            drawPoints += pad3(ix) + pad3(iy);

            ctx.lineTo(raw_ix, raw_iy);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function pad3(n) {
            return String(n).padStart(3, '0');
        }

        function sendDrawDataToROS(points) {
            const msg = new ROSLIB.Message({
                data: points
            });

            pub.publish(msg);
            console.log("å·²å‚³çµ¦ ROS:", points);
            drawPoints = "";  // æ¸…ç©ºç´€éŒ„
            newString = "3";
        }

        /* ========================================= */
        /* ç…§ç‰‡é¸æ“‡ */
        /* ========================================= */
        document.getElementById("image_change").addEventListener("change", function() {
            const value = this.value;
            const raw = document.getElementById("cam");
            const processed = document.getElementById("cam_processed");
            console.log("é¸æ“‡æˆåŠŸ")

            // å…¨éƒ¨å…ˆéš±è—
            raw.style.display = "none";
            processed.style.display = "none";

            // å†é¡¯ç¤ºé¸åˆ°çš„
            if (value === "raw") {
                raw.style.display = "block";
            } 
            else if (value === "processed") {
                processed.style.display = "block";
            }
        });

        /* ========================================= */
        /* IIII. ç‰¹æ®ŠåŠŸèƒ½ */
        /* ========================================= */
        function sendMsg(data) {
            const msg = new ROSLIB.Message({ data: String(data) });
            pub.publish(msg);
            console.log("å·²ç™¼é€:", data);
        }
    </script>
</body>
</html>